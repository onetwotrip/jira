#!/usr/bin/env ruby

require 'bundler/setup'
require 'repo'
require 'jira'
require 'issue'
require 'pullrequests'
require 'ottinfra/sendmail'
require 'erb'

cr = {
  reviewers: [],
  changes: [],
  authors: [],
  pullrequests: [],
}
# Setting variables
WORKDIR = ENV.fetch('WORKDIR', '../repos/')

SENDGRID_FROM = ENV.fetch('SG_FROM', 'default@default.com')
SENDGRID_USER = ENV.fetch('SG_USER', 'jenkins_ott')
SENDGRID_PASS = ENV.fetch('SG_KEY', 'vpfzLpbe0V5iEdgW34AQ')
JIRA_USERNAME = ENV.fetch('JIRA_USERNAME', 'default')
JIRA_PASSWORD = ENV.fetch('JIRA_PASSWORD', 'default')
JIRA_SITE = ENV.fetch('JIRA_SITE', 'default')
unless (ISSUE_ID = ENV['ISSUE'])
  puts "No issue - no cry!\n"
  exit 2
end

# Getting issie
jira = JIRA::Client.new username: JIRA_USERNAME,
                        password: JIRA_PASSWORD,
                        site: JIRA_SITE,
                        auth_type: :basic,
                        context_path: ''
issue = jira.Issue.find(ISSUE_ID)
cr[:assignee] = issue.assignee.attrs
# cr[:reviewers] << issue.assignee.emailAddress

# Getting PR
pullrequests = JIRA::PullRequests.new
issue.related['pullRequests'].each do |pr|
  if (pr['source']['url'].include? ISSUE_ID) && (pr['status'].eql? 'OPEN')
    pullrequests << pr
  end
end

# Parsing/Validating PR
pullrequests.uniq! { |i| i['source']['url'] }
unless pullrequests.valid?
  # sendmail
  fail 'Fails on PR validation'
end

# Get reviewers from changes of PR
pullrequests.each do |pr|
  # Get of merge source and destination
  src = Git::Utils.url_to_ssh pr['source']['url']
  dst = Git::Utils.url_to_ssh pr['destination']['url']
  puts "Source: #{src.to_repo_s} #{src.branch}"
  puts "Destination: #{dst.to_repo_s} #{dst.branch}"
  # Return fail if src/dist repos not equal
  unless src.to_repo_s.eql? dst.to_repo_s
    # sendmail
    fail 'Source and Destination repos in PR are different'
  end
  # Clone/Open dist branch
  repo = Git.get_branch dst.to_repo_s
  repo.fetch
  # Merge src to dist branch
  repo.merge "origin/#{src.branch}"
  # Get files change
  repo.gtree("origin/#{dst.branch}").diff('HEAD').stats[:files].keys.each do |file|
    # Get reviewer mail by file
    repo.get_attrs(file)['owner.mail'].each do |reviewer|
      cr[:changes] << file
      cr[:reviewers] += reviewer
    end
  end
  # Cleanup local repo
  repo.reset_hard "origin/#{dst.branch}"
  cr[:authors] << pr['author']['name']
  cr[:pullrequests] << Hash[url: pr['url'], name: pr['name']]
end

# Send CodeReview
unless cr[:reviewers].empty?
  message = ERB.new(File.read('views/review_mail.erb')).result
  mailer = OttInfra::SendMail.new(from: SENDGRID_FROM,
                                  user: SENDGRID_USER,
                                  pass: SENDGRID_PASS)
  mailer.sendmail(cr[:reviewers], cc: 'dmitry.shmelev@default.com',
                                  subject: 'CodeReview',
                                  message: message)
end
