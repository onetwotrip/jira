#!/usr/bin/env ruby
require 'bundler/setup'
require 'repo'
require 'jira'
require 'issue'
require 'pullrequests'
require 'ottinfra/sendmail'

require File.expand_path('../../config/environment.rb', __FILE__)

unless Config.jira[:issue]
  puts "CodeReview: No issue - no cry!\n"
  exit 2
end

# Getting issie
jira = JIRA::Client.new Config.jira
issue = jira.Issue.find(Config.jira[:issue])
pullrequests = issue.pullrequests(Config.git)
               .filter_by_status('OPEN')
               .filter_by_source_url(Config.jira[:issue])

# Parsing/Validating PR
unless pullrequests.valid?
  # Exit if pullrequests invalid
  issue.post_comment p("CodeReview: #{pullrequests.valid_msg}")
  exit
end

# Create mails
mailer = OttInfra::SendMail.new Config.sendgrid

pullrequests.each do |review|
  review.send_notify do |msg|
    mailer.add Config.sendgrid.merge message: msg
  end
end

# Send CodeReview
if mailer.mails.empty?
  puts 'CodeReview: No changes for review'
else
  mailer.sendmail
end
